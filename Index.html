<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workshop Dinamiche V4</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --bg: #f4f6f8; --primary: #34495e; --accent: #3498db; --pos: #27ae60; --neg: #e74c3c; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 0; color: #333; }
        .hidden { display: none !important; }

        /* HEADER */
        .top-bar { background: #fff; padding: 15px 30px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
        .brand { font-weight: 700; color: var(--primary); }
        .status-badge { background: #eee; padding: 5px 15px; border-radius: 20px; font-size: 0.85rem; display: flex; align-items: center; gap: 8px; }
        .dot { width: 10px; height: 10px; border-radius: 50%; background: #bdc3c7; }
        .dot.active { background: var(--pos); }

        /* LAYOUTS */
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        /* HOST: LOBBY */
        #lobby-view { text-align: center; margin-top: 50px; }
        .lobby-list { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin: 30px 0; }
        .participant-tag { background: white; padding: 10px 20px; border-radius: 30px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); font-weight: bold; animation: popIn 0.3s ease; }
        .btn-start { background: var(--primary); color: white; padding: 15px 40px; font-size: 1.5rem; border: none; border-radius: 50px; cursor: pointer; transition: 0.2s; }
        .btn-start:hover { transform: scale(1.05); background: #2c3e50; }

        /* HOST: BOARD */
        .board-grid { display: flex; gap: 30px; margin-top: 20px; }
        .column { flex: 1; background: white; border-radius: 10px; padding: 20px; min-height: 60vh; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border-top: 5px solid #ccc; }
        .col-left { border-top-color: var(--pos); } .col-right { border-top-color: var(--neg); }
        .card { padding: 15px; margin-bottom: 15px; border-radius: 5px; border: 1px solid #eee; background: #fafafa; border-left-width: 5px; animation: slideUp 0.4s; }
        .card-pos { border-left-color: var(--pos); } .card-neg { border-left-color: var(--neg); }
        
        /* PHONE: LOGIN & TARGET */
        #phone-view { max-width: 500px; margin: 0 auto; background: white; min-height: 100vh; padding: 30px; box-sizing: border-box; }
        input[type="text"] { width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 1.1rem; box-sizing: border-box; margin-bottom: 20px; }
        .target-reveal { background: #ebf5fb; padding: 20px; border-radius: 10px; text-align: center; margin-bottom: 30px; border: 2px dashed var(--accent); }
        .target-name { font-size: 1.8rem; font-weight: 800; color: var(--primary); display: block; margin-top: 10px; text-transform: uppercase; }
        
        textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; margin-bottom: 10px; font-family: inherit; }
        .btn-send { width: 100%; padding: 15px; background: var(--accent); color: white; border: none; border-radius: 8px; font-size: 1.2rem; cursor: pointer; }
        
        /* UTILS */
        #qr-box { margin: 20px auto; width: 150px; }
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @media print { .top-bar, #lobby-view, .no-print { display: none !important; } .board-grid { display: block; } }
    </style>
</head>
<body>

    <div id="host-panel" class="hidden">
        <div class="top-bar">
            <div class="brand">WORKSHOP DINAMICHE</div>
            <div class="status-badge"><span id="conn-dot" class="dot"></span> <span id="room-id">...</span></div>
        </div>

        <div id="lobby-view" class="container">
            <h1>Registrazione Partecipanti</h1>
            <p>Scansionate il QR Code e inserite il vostro nome.</p>
            <div id="qr-box"></div>
            
            <div class="lobby-list" id="participants-list">
                </div>
            
            <div id="lobby-controls" class="hidden">
                <p style="color:#666; margin-bottom:20px;">Attendere che tutti siano connessi.</p>
                <button class="btn-start" onclick="assignTargets()">üéØ ASSEGNA OBIETTIVI E INIZIA</button>
            </div>
            
            <p id="waiting-msg" style="margin-top:20px; font-style:italic; color:#999;">In attesa del primo partecipante...</p>
        </div>

        <div id="board-view" class="container hidden">
            <div style="text-align:center; margin-bottom:20px;">
                <h2>Analisi Incrociata (Anonima)</h2>
                <button onclick="window.print()" style="padding:5px 15px; cursor:pointer;" class="no-print">Stampa PDF</button>
            </div>
            <div class="board-grid">
                <div class="column col-left">
                    <h3 style="text-align:center; color:var(--pos)">Ispirazioni (Da Copiare)</h3>
                    <div id="col-pos"></div>
                </div>
                <div class="column col-right">
                    <h3 style="text-align:center; color:var(--neg)">Sfide & Strategie</h3>
                    <div id="col-neg"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="phone-view" class="hidden">
        <div id="p-login">
            <h2 style="text-align:center">Benvenuto</h2>
            <p>Inserisci il tuo nome per partecipare.</p>
            <input type="text" id="my-name" placeholder="Il tuo nome..." />
            <button class="btn-send" onclick="joinLobby()">ENTRA NELLA STANZA</button>
        </div>

        <div id="p-wait" class="hidden" style="text-align:center; padding-top:50px;">
            <h3>Sei dentro!</h3>
            <p>Attendi che l'host avvii la sessione...</p>
            <div style="font-size:3rem; margin-top:20px;">‚è≥</div>
        </div>

        <div id="p-input" class="hidden">
            <div class="target-reveal">
                <small>IL TUO SOGGETTO DI ANALISI √à:</small>
                <span id="target-display" class="target-name">...</span>
                <small style="color:#666; display:block; margin-top:5px;">(Solo tu vedi questo nome)</small>
            </div>

            <div style="background:#f9f9f9; padding:15px; border-radius:8px; margin-bottom:15px; border-left:4px solid var(--pos);">
                <strong>1. Cosa ammiri di questa persona?</strong>
                <p style="font-size:0.8rem; margin:5px 0;">Una qualit√† specifica che vorresti "rubare".</p>
                <textarea id="admire" rows="3"></textarea>
            </div>

            <div style="background:#f9f9f9; padding:15px; border-radius:8px; margin-bottom:15px; border-left:4px solid var(--neg);">
                <strong>2. Un comportamento difficile?</strong>
                <p style="font-size:0.8rem; margin:5px 0;">Cosa ti crea attrito e qual √® la TUA strategia per gestirlo?</p>
                <textarea id="annoy" rows="2" placeholder="Il comportamento..."></textarea>
                <textarea id="strategy" rows="2" placeholder="La tua strategia di risposta..." style="background:#fff0f5"></textarea>
            </div>

            <button class="btn-send" onclick="submitFeedback()">INVIA (ANONIMO)</button>
            <p id="sent-msg" style="text-align:center; color:green; font-weight:bold; margin-top:10px;"></p>
        </div>
    </div>

    <script>
        // --- CONFIGURAZIONE ---
        const urlParams = new URLSearchParams(window.location.search);
        let roomId = urlParams.get('room');
        const isHost = !roomId;
        let myId = localStorage.getItem('ws_uid') || Math.random().toString(36).substr(2, 9);
        localStorage.setItem('ws_uid', myId);

        if (isHost) roomId = Math.floor(1000 + Math.random() * 9000).toString();
        
        const TOPIC = `ws-v4-${roomId}`;
        const NTFY = `https://ntfy.sh/${TOPIC}`;
        let participants = []; // Solo Host usa questo

        // --- INIT ---
        if (isHost) initHost();
        else initPhone();

        // --- HOST LOGIC ---
        function initHost() {
            document.getElementById('host-panel').classList.remove('hidden');
            document.getElementById('room-id').innerText = `STANZA: ${roomId}`;
            
            // QR Code
            new QRCode(document.getElementById("qr-box"), {
                text: `${window.location.origin}${window.location.pathname}?room=${roomId}`,
                width: 150, height: 150
            });

            // Listen for events
            const sse = new EventSource(`${NTFY}/sse`);
            sse.onopen = () => document.getElementById('conn-dot').classList.add('active');
            sse.onmessage = (e) => {
                try {
                    const data = JSON.parse(e.data);
                    if (data.event === 'message') handleHostMessage(JSON.parse(data.message));
                } catch(err){}
            };
        }

        function handleHostMessage(msg) {
            if (msg.type === 'join') {
                // Evita duplicati
                if (!participants.find(p => p.id === msg.id)) {
                    participants.push({ name: msg.name, id: msg.id });
                    renderLobby();
                }
            } else if (msg.type === 'feedback') {
                renderCard(msg);
            }
        }

        function renderLobby() {
            const list = document.getElementById('participants-list');
            list.innerHTML = participants.map(p => `<div class="participant-tag">${p.name}</div>`).join('');
            document.getElementById('waiting-msg').classList.add('hidden');
            if (participants.length > 1) document.getElementById('lobby-controls').classList.remove('hidden');
        }

        function assignTargets() {
            if (participants.length < 2) return alert("Servono almeno 2 persone!");
            
            // 1. Shuffle
            let shuffled = [...participants];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }

            // 2. Create Map (Circular)
            let pairings = {};
            for (let i = 0; i < shuffled.length; i++) {
                let observer = shuffled[i];
                let target = shuffled[(i + 1) % shuffled.length]; // L'ultimo osserva il primo
                pairings[observer.id] = target.name;
            }

            // 3. Broadcast
            fetch(NTFY, {
                method: 'POST',
                body: JSON.stringify({ type: 'start', pairs: pairings })
            });

            // 4. Switch View
            document.getElementById('lobby-view').classList.add('hidden');
            document.getElementById('board-view').classList.remove('hidden');
        }

        function renderCard(data) {
            if (data.admire) {
                const div = document.createElement('div');
                div.className = 'card card-pos';
                div.innerText = data.admire;
                document.getElementById('col-pos').prepend(div);
            }
            if (data.annoy) {
                const div = document.createElement('div');
                div.className = 'card card-neg';
                div.innerHTML = `<strong>${data.annoy}</strong><br><small style="color:#c0392b">STRATEGIA: ${data.strategy}</small>`;
                document.getElementById('col-neg').prepend(div);
            }
        }

        // --- PHONE LOGIC ---
        function initPhone() {
            document.getElementById('phone-view').classList.remove('hidden');
            
            // Listen for start
            const sse = new EventSource(`${NTFY}/sse`);
            sse.onmessage = (e) => {
                try {
                    const data = JSON.parse(e.data);
                    if (data.event === 'message') {
                        const msg = JSON.parse(data.message);
                        if (msg.type === 'start') revealTarget(msg.pairs);
                    }
                } catch(err){}
            };
        }

        function joinLobby() {
            const name = document.getElementById('my-name').value.trim();
            if (!name) return alert("Inserisci un nome");
            
            // Send join
            fetch(NTFY, {
                method: 'POST',
                body: JSON.stringify({ type: 'join', name: name, id: myId })
            }).then(() => {
                document.getElementById('p-login').classList.add('hidden');
                document.getElementById('p-wait').classList.remove('hidden');
            });
        }

        function revealTarget(pairs) {
            const myTarget = pairs[myId];
            if (myTarget) {
                document.getElementById('p-wait').classList.add('hidden');
                document.getElementById('p-input').classList.remove('hidden');
                document.getElementById('target-display').innerText = myTarget;
            }
        }

        function submitFeedback() {
            const btn = document.querySelector('.btn-send');
            const data = {
                type: 'feedback',
                admire: document.getElementById('admire').value,
                annoy: document.getElementById('annoy').value,
                strategy: document.getElementById('strategy').value
            };

            if(!data.admire && !data.annoy) return alert("Compila almeno un campo");

            btn.disabled = true;
            btn.innerText = "Invio...";

            fetch(NTFY, { method: 'POST', body: JSON.stringify(data) })
            .then(() => {
                document.getElementById('sent-msg').innerText = "Feedback Inviato!";
                document.getElementById('p-input').innerHTML = "<h3 style='text-align:center'>Grazie del contributo.</h3><p style='text-align:center'>Guarda la lavagna.</p>";
            });
        }
    </script>
</body>
</html>
